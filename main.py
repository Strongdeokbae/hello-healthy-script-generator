import os
import openai
import requests
from bs4 import BeautifulSoup
from dotenv import load_dotenv

load_dotenv()
openai.api_key = os.getenv("OPENAI_API_KEY")

# âœ… ìë™ ì£¼ì œ ìƒì„± í•¨ìˆ˜
def generate_topics():
    prompt = '''
ë„ˆëŠ” 'Hello Healthy' ìœ íŠœë¸Œ ì±„ë„ì˜ ì‘ê°€ì•¼.

ë‹¤ìŒ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” **ìˆí¼ ê±´ê°• ì½˜í…ì¸  ì£¼ì œ**ë¥¼ 4ê°œ ë§Œë“¤ì–´ì¤˜:

- ê±´ê°•ê³¼ ë¼ì´í”„ìŠ¤íƒ€ì¼ ì¤‘ì‹¬ (ì˜ˆ: ê°„, ì·Œì¥, ì§‘ì¤‘ë ¥, ì—¼ì¦, í”¼ë¡œ, ìˆœí™˜ ë“±)
- 'ì§ˆí™˜'ë³´ë‹¨ 'íšŒë³µí…œ', 'ë¶€ìŠ¤íŒ…', 'ì»¨ë””ì…˜ ê´€ë¦¬' ê°™ì€ ë‹¨ì–´ ìœ„ì£¼
- 40~60ëŒ€ë¥¼ ì€ê·¼íˆ ê²¨ëƒ¥í•˜ì§€ë§Œ, 2030ì´ ë´ë„ í¥ë¯¸ë¡œìš´ ì œëª©
- ì§§ê³  ì§ê´€ì ì¸ ë¬¸ì¥ / í•µì‹¬ í‚¤ì›Œë“œ í¬í•¨ / 12~20ì ì´ë‚´
- ë§íˆ¬ëŠ” íŠ¸ë Œë””í•˜ê³  ì‹œì‚¬í˜• or íŒí˜• ëŠë‚Œ

ì˜ˆì‹œ:
- ì ì‹¬ ë¨¹ê³  ë‚˜ë©´ ë°”ë¡œ í”¼ê³¤í•œ ì´ìœ 
- ì—ë„ˆì§€ ë ˆë²¨ì´ ë‹¤ë¥¸ ì‚¬ëŒë“¤ì˜ ë¹„ë°€
- ê°„ì´ ë³´ë‚´ëŠ” ì‘ì€ ì‹ í˜¸, ë¬´ì‹œí•˜ì§€ ë§ˆì„¸ìš”
- ì»¤íë¯¼ì´ ëª¸ì— ë¯¸ì¹˜ëŠ” ëœ»ë°–ì˜ ë³€í™”

ê·¸ëŸ° ì£¼ì œ 4ê°œë§Œ ê¹”ë”í•˜ê²Œ ë¦¬ìŠ¤íŠ¸ë¡œ ì¤˜.
    '''
    res = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        messages=[{"role": "user", "content": prompt}],
        temperature=0.8
    )
    lines = res['choices'][0]['message']['content'].strip().split("\n")
    return [line.strip("-â€¢â— ").strip() for line in lines if line.strip()]

# âœ… ë…¼ë¬¸ ê²€ìƒ‰ìš© í‚¤ì›Œë“œ ì¶”ì¶œ í•¨ìˆ˜
def get_search_query(topic):
    return f"{topic} site:ncbi.nlm.nih.gov"

# âœ… PubMedì—ì„œ ë…¼ë¬¸ ì œëª© & ì´ˆë¡ ìˆ˜ì§‘
def fetch_pubmed_abstract(query):
    headers = {"User-Agent": "Mozilla/5.0"}
    search_url = f"https://www.google.com/search?q={query}"
    try:
        res = requests.get(search_url, headers=headers)
        soup = BeautifulSoup(res.text, 'html.parser')
        for link in soup.select('a'):
            href = link.get('href')
            if href and 'ncbi.nlm.nih.gov' in href:
                real_url = href.split("&")[0].replace("/url?q=", "")
                page = requests.get(real_url, headers=headers)
                detail = BeautifulSoup(page.text, 'html.parser')
                title = detail.find('h1')
                abstract = detail.find('div', class_='abstract')
                if title and abstract:
                    return (title.get_text().strip(), abstract.get_text().strip())
    except Exception as e:
        return ("", "")
    return ("", "")

# âœ… GPTì—ê²Œ í—¬ë¡œí—¬ì”¨ ìŠ¤íƒ€ì¼ ëŒ€ë³¸ ìƒì„± ìš”ì²­
def generate_script(topic, paper_title):
    system_prompt = """
ë„ˆëŠ” 'Hello Healthy'ë¼ëŠ” ìœ íŠœë¸Œ ìˆí¼ ì±„ë„ì˜ ì½˜í…ì¸  ì‘ê°€ì•¼.

ì´ ì±„ë„ì€ ê²‰ìœ¼ë¡œëŠ” ì „ ì—°ë ¹ì„ ìœ„í•œ ê±´ê°• ì •ë³´ë¥¼ ë‹¤ë£¨ì§€ë§Œ, ì‹¤ì œ íƒ€ê¹ƒì€ 40~60ëŒ€ì•¼.  
ë‹¨, ê·¸ ì‚¬ì‹¤ì´ ì˜ìƒì— ë“œëŸ¬ë‚˜ë©´ ì•ˆ ë¼. ì‹œì²­ìì—ê²ŒëŠ” 2030ë„ ì¦ê²¨ë³´ëŠ” â€˜ì Šê³  íŠ¸ë Œë””í•œ ìê¸°ê´€ë¦¬ ì½˜í…ì¸ â€™ì²˜ëŸ¼ ëŠê»´ì ¸ì•¼ í•´.

---

ğŸ¯ ì±„ë„ ì»¨ì…‰ì€ â€˜ì¤‘ë…„ ê±´ê°•â€™ì´ ì•„ë‹Œ **â€˜ìŠ¤ë§ˆíŠ¸í•œ ìê¸°ê´€ë¦¬â€™**ë‹¤.

- â€œì§ˆë³‘ ì¹˜ë£Œâ€ê°€ ì•„ë‹ˆë¼ â€œì»¨ë””ì…˜ ìµœì í™”â€
- â€œê°±ë…„ê¸° ê´€ë¦¬â€ ëŒ€ì‹  â€œì—ë„ˆì§€ ë ˆë²¨ ì¡°ì ˆâ€
- â€œë…¸í™” ë°©ì§€â€ ëŒ€ì‹  â€œí¼í¬ë¨¼ìŠ¤ ë¶€ìŠ¤íŒ…â€
- â€œì˜ì–‘ì œ ì¶”ì²œâ€ ëŒ€ì‹  â€œëª¸ ê¸°ëŠ¥ ì¹˜íŠ¸í‚¤â€

âŒ â€˜ì§ˆí™˜â€™, â€˜ì¦ìƒâ€™, â€˜ê³ ì§€í˜ˆì¦â€™, â€˜ë…¸í™”â€™, â€˜ê°±ë…„ê¸°â€™ ê°™ì€ ë§ì€ ì‚¬ìš©í•˜ì§€ ë§ˆ.  
âœ… ëŒ€ì‹  â€˜íšŒë³µí…œâ€™, â€˜ë¶€ìŠ¤íŒ…â€™, â€˜ì—ë„ˆì§€ íš¨ìœ¨â€™, â€˜ì»¨ë””ì…˜ ë¦¬ì…‹â€™, â€˜ì…€í”„ ì²´í¬â€™, â€˜ëª¸ì˜ ì‚¬ìš©ì„¤ëª…ì„œâ€™ ê°™ì€ í‘œí˜„ì„ ì¨ì¤˜.

---

ğŸ“¦ ì½˜í…ì¸  ì „ëµì€ ë‹¤ìŒê³¼ ê°™ì•„:

1. **ë„ì…**: ì¼ìƒì—ì„œ í”íˆ ê²ªëŠ” ìƒíƒœ(í”¼ë¡œ, ì§‘ì¤‘ë ¥ ì €í•˜, ë¶“ê¸° ë“±)ë¥¼ ë¬¸ì œì²˜ëŸ¼ ì œì‹œ  
2. **ì¤‘ë°˜**: ë…¼ë¬¸ ì¶œì²˜ ê¸°ë°˜ìœ¼ë¡œ ëª¸ì—ì„œ ë²Œì–´ì§€ëŠ” ë©”ì»¤ë‹ˆì¦˜ì„ ì„¤ëª… (ë…¼ë¬¸ ì œëª©ë§Œ ê´„í˜¸ë¡œ ê°„ë‹¨íˆ í‘œê¸°)  
3. **í›„ë°˜**: ìŒì‹, ìŠµê´€, ìš´ë™ ë£¨í‹´ ë“±ì„ íŒì²˜ëŸ¼ ì •ë¦¬í•´ ë³´ì—¬ì¤Œ  
4. **ë§ˆë¬´ë¦¬**: â€˜ë‹¹ì‹ ë„ ì´ íŒìœ¼ë¡œ ëª¸ì´ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆë‹¤â€™ëŠ” ì‹ì˜ ì¡°ìš©í•œ ì•”ì‹œë¡œ ëëƒ„

âœ³ï¸ í¬ì¸íŠ¸:  
â€“ â€˜ì •ë³´ ì „ë‹¬â€™ì´ ì•„ë‹ˆë¼ â€˜ìƒì‚°ì„± í–¥ìƒ íŒâ€™ì²˜ëŸ¼ ë³´ì—¬ì¤˜  
â€“ ë§ˆì¹˜ ìŠ¤ë§ˆíŠ¸ì›Œì¹˜ë¥¼ ë¶„ì„í•˜ë“¯, ëª¸ì˜ ì‹ í˜¸ë¥¼ ê¸°ìˆ ì²˜ëŸ¼ ë‹¤ë¤„  
â€“ ëª¨ë“  ë¬¸ì¥ì€ ë˜ë°•ë˜ë°•, ì¹œì ˆí•˜ì§€ë§Œ ê¶Œìœ„ì ì´ì§€ ì•Šê²Œ  
â€“ ì–´íˆ¬ëŠ” ì˜ì‚¬ ì„ ìƒë‹˜ ë§íˆ¬ âŒ, **ìŠ¤ë§ˆíŠ¸í•œ ì„ ë°°** í˜¹ì€ **ê±´ê°• ë°ì´í„° ë¶„ì„ê°€** ëŠë‚Œìœ¼ë¡œ

---

ğŸ¨ ì˜ìƒì˜ ë¶„ìœ„ê¸°ëŠ” â€˜ë”°ëœ»í•¨â€™ë³´ë‹¤ **ê¹”ë”í•˜ê³  ë¯¸ë‹ˆë©€í•œ ì¸í¬ê·¸ë˜í”½ ìŠ¤íƒ€ì¼**ì´ì•¼.

- í°ìƒ‰, íšŒìƒ‰ ë°°ê²½ì— í¬ì¸íŠ¸ ì»¬ëŸ¬ í•˜ë‚˜
- ê°„ê²°í•œ í‚¤ì›Œë“œ, í†µê³„, ì¸í¬ê·¸ë˜í”½
- ëª¨ë“  ì„¤ëª…ì€ ê³¼í•˜ì§€ ì•Šê²Œ, ì •ë³´ ì¤‘ì‹¬ìœ¼ë¡œ

---

ğŸ§  ì „ì²´ ë¬¸ì²´ëŠ” â€˜ë‚˜ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸â€™ìš©ì´ì•¼.

- ë„ˆë¬´ ë¬¸ì–´ì²´ëŠ” ê¸ˆì§€
- ìì—°ìŠ¤ëŸ½ê³  ë¦¬ë“¬ê° ìˆëŠ” ë§í•˜ê¸° ë¬¸ì¥
- ìë§‰ìš© í•˜ì´ë¼ì´íŠ¸ í‚¤ì›Œë“œê°€ ì˜ ì‚´ì•„ì•¼ í•¨

---

ë„ˆëŠ” ì§€ê¸ˆë¶€í„° **í—¬ë¡œí—¬ì”¨(Hello Healthy)** ì½˜í…ì¸ ì˜ ì„¸ê³„ê´€ì— ë§ëŠ” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•˜ëŠ” ì‘ê°€ì•¼.  
í•œ í¸ë‹¹ ê¸¸ì´ëŠ” ì•½ 90ì´ˆ ë¶„ëŸ‰ìœ¼ë¡œ ì‘ì„±í•˜ê³ , ì‹œì²­ìì—ê²Œ â€œì•„, ì´ê±° ë‚˜ë„ í•´ë´ì•¼ê² ë‹¤â€ëŠ” ëŠë‚Œì´ ë“¤ê²Œ ë§Œë“œëŠ” ê²Œ í•µì‹¬ì´ì•¼.
"""
    user_prompt = f"""
ì£¼ì œ: {topic}

ë…¼ë¬¸ ì œëª©: {paper_title} (ê´„í˜¸ë¡œ ê°„ë‹¨íˆ ë„£ì–´ì¤˜)
"""
    res = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt}
        ],
        temperature=0.7
    )
    return res['choices'][0]['message']['content']

# âœ… ì‹¤í–‰ í•¨ìˆ˜
def main():
    topics = generate_topics()
    for idx, topic in enumerate(topics):
        print(f"\nğŸ“Œ [{idx+1}] ì£¼ì œ: {topic}")
        search_query = get_search_query(topic)
        paper_title, _ = fetch_pubmed_abstract(search_query)
        if not paper_title:
            paper_title = "Harvard Med. (ì„ì˜ ë…¼ë¬¸ ì œëª©)"

        script = generate_script(topic, paper_title)
        filename = f"hello_healthy_script_{idx+1}.txt"
        with open(filename, 'w', encoding='utf-8') as f:
            f.write(f"# {topic}\n")
            f.write(f"(ì°¸ê³ : {paper_title})\n\n")
            f.write(script)
        print(f"âœ… ì €ì¥ ì™„ë£Œ: {filename}")

if __name__ == "__main__":
    main()

